## Terraform - EC2 Instances IAM Policies Restrictions by Tag

This is meant to build an environment in AWS prepared to test users IAM Policies restrictions on EC2 Instances based on Tags. That's why the configuration is not properly done as it should (with Enviroment variable point to the target environment PROD or DEV, subfolders for variables with diferents values on them, etc.)

This script should build:
- Two EC2 Instances, one with the Tag Environment=Dev and another with the Environment=Tag

```bash
# The S3 Bucket is necessary to storage the Terraform state remotely
# The DynamoDB table is necessary to Lock the State while a user is being running the Terraform against it

## Steps
# Init (With DynamoDB Control for Locking)
terraform init -backend-config="key=terraform/infrastructure.tfstate" -backend-config="dynamodb_table=terraform_remote_state_lock" -var-file="infra.tfvars" -backend=true -get=true -lock=true 
# Init (Without DynamoDB)
terraform init -backend-config="key=terraform/infrastructure.tfstate"  -var-file="infra.tfvars" -backend=true -get=true -lock=true
# Plan
terraform plan -var-file="infra.tfvars" -out tfplan
# Apply
terraform apply --auto-approve -no-color -lock=true tfplan 
# Output
terraform output john_password | base64 -d | gpg --decrypt
# Destroy
terraform destroy -no-color -lock=true -var-file="infra.tfvars"

# Create Workspaces
terraform workspace new dev
terraform workspace new stg
terraform workspace new prod

# Change to a Workspace
terraform workspace select dev

# Launch/Upgrade Terraform
terraform init -upgrade=true -var-file=vars/dev.tfvars
terraform apply -var-file=vars/dev.tfvars
```
AWS CLI
```bash
# Look up an EC2 Instances by filter
aws ec2 describe-images --filters "Name=image-id,Values=ami-07eda9385feb1e969" --region eu-west-3

aws ec2 describe-images --filter "Name=image-id,Values=ami-09def150731bdbcc2" --region eu-central-1

# Create S3 Bucket for Backend
aws s3api create-bucket --bucket iac-ec2-remote-state --region eu-west-3 --create-bucket-configuration LocationConstraint=eu-west-3

# Import an existing AWS Instance (must be change the terrafor configuration script to add the aws instance example before)
terraform import -var-file=dev/infra.tfvars  aws_instance.example i-0953368a71600c848
``` 
#

### PGP Keys for IAM User Console Login Creationg
To create a user with Console Login access, we need to provide to Terraform (AWS Resources) a PGP Key (public key part), to enable the encryption of his Password. Then after the creation, we can decrypt the generated password with our PGP Key (private key part).

References:
- https://www.vaultproject.io/docs/concepts/pgp-gpg-keybase.html
- https://keybase.io/docs/command_line/basics
- https://stackoverflow.com/questions/53534722/how-to-enable-the-console-login-for-iam-user-in-terraform


#### Using GPG Linux
```bash
# Install
sudo apt-get install gpa gnupg2

gpg --gen-key #or gpg --full-generate-key
# List Keys
gpg -k
# List Secret Keys
gpg -K
gpg -K 'john.silva'
# Get the Fingerpint of the Public Key
export FINGERPRINT=$(gpg -K 'john.silva' | awk 'FNR == 2 {print $1}')
# Base64 Public Key Exported <-- Use this value as pgp_key at AWS Terraform Resource like at: aws_iam_user_login_profile
gpg --export $FINGERPRINT | base64
# Base64 Private Key Exported
gpg --export-secret-keys $FINGERPRINT | base64

# Decrypt Password Generated by AWS to User --> Terraform output
terraform output john_password | base64 -d | gpg --decrypt

```

#### Using Keybase 
```bash
curl --remote-name https://prerelease.keybase.io/keybase_amd64.deb
sudo apt install ./keybase_amd64.deb
# To run Keybase
run_keybase

# Generate the Keys
keybase pgp gen  #Must be logged in (run_keybased)
keybase pgp list
```